<?php
header('Content-Type: application/json'); include_once("config.php"); $method = $_SERVER['REQUEST_METHOD']; function lastID($dbConn){ $sql = "SELECT count(*) FROM dispatch"; $result = $dbConn->prepare($sql); $result->execute(); return $result->fetchColumn(); } switch($method) { case 'GET': if (isset( $_GET['id'])) { $id = $_GET['id']; $sql = "SELECT * FROM dispatch WHERE id=:id"; $query = $dbConn->prepare($sql); $query->execute(array(':id' => $id)); header("HTTP/1.1 200 "); echo json_encode($query->fetchAll(PDO::FETCH_ASSOC)); } else{ $stmt = $dbConn->prepare("SELECT * FROM dispatch"); $stmt->execute(); $result = $stmt->fetchAll(PDO::FETCH_ASSOC); header("HTTP/1.1 200 "); echo json_encode($result); } break; case 'POST': $data = json_decode(file_get_contents("php://input"), true); $dispatch_id ="DPE_".sprintf('%04s', lastID($dbConn)+1); $first_name = $data['first_name']; $last_name = $data['last_name']; $phone_number = $data['phone_number']; $bike_number_plate = $data['bike_number_plate']; $riders_license = $data['riders_license']; $date_created = date("Y-m-d"); $stmt = $dbConn->prepare("INSERT INTO dispatch (dispatch_id, first_name, last_name, phone_number, bike_number_plate, riders_license, date_created) VALUES (:dispatch_id, :first_name, :last_name, :phone_number, :bike_number_plate, :riders_license, :date_created)"); $stmt->bindValue(':dispatch_id', $dispatch_id); $stmt->bindValue(':first_name', $first_name); $stmt->bindValue(':last_name', $last_name); $stmt->bindValue(':phone_number', $phone_number); $stmt->bindValue(':bike_number_plate', $bike_number_plate); $stmt->bindValue(':riders_license', $riders_license); $stmt->bindValue(':date_created', $date_created); $stmt->execute(); header("HTTP/1.1 201 Created"); header('Content-Type: application/json'); $response = array('status' => 'success'); echo json_encode($response); break; case 'PUT': parse_str(file_get_contents("php://input"),$put_vars); $id = $put_vars['id']; $dispatch_id = $put_vars['dispatch_id']; $first_name = $put_vars['first_name']; $last_name = $put_vars['last_name']; $phone_number = $put_vars['phone_number']; $bike_number_plate = $put_vars['bike_number_plate']; $riders_license = $put_vars['riders_license']; $date_created = $put_vars['date_created']; $stmt = $dbConn->prepare("UPDATE dispatch SET dispatch_id=:dispatch_id, first_name=:first_name, last_name=:last_name, phone_number=:phone_number, bike_number_plate=:bike_number_plate, riders_license=:riders_license, date_created=:date_created WHERE id=:id"); $stmt->bindValue(':dispatch_id', $dispatch_id); $stmt->bindValue(':first_name', $first_name); $stmt->bindValue(':last_name', $last_name); $stmt->bindValue(':phone_number', $phone_number); $stmt->bindValue(':bike_number_plate', $bike_number_plate); $stmt->bindValue(':riders_license', $riders_license); $stmt->bindValue(':date_created', $date_created); $stmt->bindValue(':id', $id); $stmt->execute(); header("HTTP/1.1 200 OK"); $response = array('message' => 'Dispatch record updated'); echo json_encode($response); break; case 'DELETE': $data = json_decode(file_get_contents("php://input"), true);$id = $data['id']; $sql = "DELETE FROM dispatch WHERE id=:id"; $query = $dbConn->prepare($sql); header("HTTP/1.1 204 No Content"); echo json_encode( $query->execute(array(':id' => $id))); break; } ?>