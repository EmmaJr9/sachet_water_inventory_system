<?php
include_once("config.php"); ; function chk($dbConn){ $date = date("Y-m-d"); $sql = "SELECT count(*) FROM stock WHERE `date`=:id"; $query = $dbConn->prepare($sql); $query->execute(array(':id' => $date)); $result = $query->fetch(); if($result[0] == 0) { return False; } return True; } function previousQuality ($dbConn) { $date = date('Y-m-d',strtotime("-1 days")); $sql = "SELECT stock_current FROM stock WHERE `date`=:id"; $query = $dbConn->prepare($sql); $query->execute(array(':id' => $date)); $result = $query->fetch(); if(!$result) { return 0; } return ($result[0]); } function lastID($dbConn){ $sql = "SELECT count(*) FROM stock"; $result = $dbConn->prepare($sql); $result->execute(); return $result->fetchColumn(); } if ($_SERVER['REQUEST_METHOD'] == 'POST') { $data = json_decode(file_get_contents("php://input"), true); $stock_id = "STK_".sprintf('%04s', lastID($dbConn)+1); $stock_current = previousQuality ($dbConn) + $data['stock_produced']; $stock_previous = previousQuality ($dbConn); $stock_produced = $data['stock_produced']; $date = date("Y-m-d"); if(!chk($dbConn)) { $sql = "INSERT INTO stock (id, stock_id, stock_current, stock_previous, stock_produced, date) VALUES (null, :stock_id, :stock_current, :stock_previous, :stock_produced, :date)"; $query = $dbConn->prepare($sql); $query->bindparam(':stock_id', $stock_id); $query->bindparam(':stock_current', $stock_current); $query->bindparam(':stock_previous', $stock_previous); $query->bindparam(':stock_produced', $stock_produced); $query->bindparam(':date', $date); $query->execute(); echo json_encode(array('message' => 'Stock record inserted')); } } if ($_SERVER['REQUEST_METHOD'] == 'PUT') { $data = json_decode(file_get_contents("php://input"), true); $id = $data['id']; $stock_current = $data['stock_current']; $sql = "UPDATE stock SET  stock_current=:stock_current WHERE id=:id"; $query = $dbConn->prepare($sql); $query->bindparam(':id', $id); $query->bindparam(':stock_current', $stock_current); $query->execute(); echo json_encode(array('message' => 'Stock record updated')); } if ($_SERVER['REQUEST_METHOD'] == 'DELETE') { $data = json_decode(file_get_contents("php://input"), true);$id = $data['id']; $sql = "DELETE FROM stock WHERE id=:id"; $query = $dbConn->prepare($sql); $query->execute(array(':id' => $id)); echo json_encode(array('message' => 'Stock record deleted')); } if ($_SERVER['REQUEST_METHOD'] == 'GET' && !isset($_GET['r']) ){ $result = $dbConn->query("SELECT * FROM stock ORDER BY id DESC")->fetchAll(PDO::FETCH_ASSOC); echo json_encode($result); } if ($_SERVER['REQUEST_METHOD'] == 'GET' && isset($_GET['r'])) { $date = date("Y-m-d"); $sql = "SELECT * FROM stock WHERE `date`=:id"; $query = $dbConn->prepare($sql); $query->execute(array(':id' => $date)); $result = $query->fetchAll(PDO::FETCH_ASSOC); echo json_encode($result); $dbConn = null; } $dbConn = null; ?>